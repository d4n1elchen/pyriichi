# PyRiichi 測試覆蓋率報告

生成時間：2024年（已更新）

## 總體覆蓋率

**總體覆蓋率：78%** (1850 行代碼，415 行未覆蓋) ⬆️ **提升 1%**（累計提升 10%）

目標覆蓋率：> 80%

## 各模組覆蓋率詳情

### ✅ 完美覆蓋（100%）
- `pyriichi/__init__.py`: 100% (9/9 行)
- `pyriichi/game_state.py`: 100% (76/76 行) ⬆️ **從 66% 提升到 100%**

### 🟢 良好覆蓋（≥75%）
- `pyriichi/hand.py`: 86% (267/311 行) ⬆️ **從 75% 提升到 86%**
- `pyriichi/scoring.py`: 89% (142/159 行) ⬆️ **從 75% 提升到 89%**（大幅改善）
- `pyriichi/tiles.py`: 81% (109/134 行) ⬆️ **從 78% 提升到 81%**
- `pyriichi/yaku.py`: 77% (584/759 行)

### 🟡 中等覆蓋（60-75%）
- `pyriichi/utils.py`: 72% (18/25 行)
- `pyriichi/rules.py`: 62% (235/377 行) ⬆️ **從 60% 提升到 62%**

## 主要未覆蓋區域

### 1. `pyriichi/rules.py` (43% 覆蓋率)

**未覆蓋的主要功能：**
- **KAN/ANKAN 動作處理** (230-300行)
  - 明槓（KAN）操作
  - 暗槓（ANKAN）操作
  - 搶槓檢查（_check_chankan）
  - 嶺上開花（check_rinshan_win）
  - 王牌區耗盡處理

- **三家和了檢查** (698-720行)
  - check_sancha_ron() 方法

- **流局處理相關** (374-401, 488-609行)
  - handle_draw() 方法
  - end_round() 方法
  - 流局滿貫處理
  - 九種九牌流局處理

- **其他邊界情況**
  - can_act() 中的 KAN/ANKAN 檢查 (152-160行)
  - 各種錯誤處理路徑

### 2. `pyriichi/scoring.py` (62% 覆蓋率)

**未覆蓋的主要功能：**
- **聽牌符計算** (283-349行)
  - _determine_waiting_type() 方法
  - 各種聽牌類型判定（兩面、邊張、嵌張、單騎、雙碰）

- **支付方式計算** (53-100行)
  - calculate_payments() 方法
  - 自摸支付邏輯
  - 榮和支付邏輯
  - 本場和供託處理

- **槓子符計算** (229-243行)
  - 明槓和暗槓的符數計算

### 3. `pyriichi/game_state.py` (66% 覆蓋率)

**未覆蓋的主要功能：**
- **狀態轉換方法** (85-147行)
  - next_round() 方法
  - next_dealer() 方法
  - transfer_points() 方法
  - 各種邊界情況處理

### 4. `pyriichi/hand.py` (75% 覆蓋率)

**未覆蓋的主要功能：**
- **槓操作** (231-317行)
  - can_kan() 方法
  - kan() 方法
  - 明槓、暗槓、加槓的邏輯

- **邊界情況**
  - 各種錯誤處理路徑

## 最新進展（2024年更新）

### 新增測試用例
- ✅ 新增 69 個測試用例（從 59 個增加到 128 個）
- ✅ 新增 `test_game_state.py` 測試文件（12 個測試）
- ✅ 新增 `test_hand.py` 中的槓操作測試（2 個測試）
- ✅ 新增 `test_rules.py` 中的 KAN/ANKAN、流局處理和錯誤處理測試（30 個測試）
- ✅ 新增 `test_scoring.py` 中的聽牌符、槓子符、雀頭符和支付方式測試（25 個測試）

### 覆蓋率提升
- ✅ **總體覆蓋率：68% → 78%**（提升 10%，距離 80% 目標僅差 2%）
- ✅ **game_state.py：66% → 100%**（提升 34%）
- ✅ **hand.py：75% → 86%**（提升 11%）
- ✅ **rules.py：43% → 62%**（提升 19%）
- ✅ **scoring.py：62% → 89%**（提升 27%，大幅改善）
- ✅ **tiles.py：78% → 81%**（提升 3%）

## 改進建議

### 優先級 1：繼續提高 rules.py 覆蓋率（目標：> 70%）

需要添加的測試：
1. **KAN/ANKAN 動作測試**
   - 測試明槓操作
   - 測試暗槓操作
   - 測試搶槓和牌
   - 測試嶺上開花
   - 測試王牌區耗盡

2. **三家和了測試**
   - 測試多人和牌情況
   - 測試三家和了流局

3. **流局處理測試**
   - 測試 handle_draw()
   - 測試 end_round()
   - 測試流局滿貫
   - 測試九種九牌流局

### 優先級 2：繼續提高 scoring.py 覆蓋率（目標：> 75%）- ✅ **已完成**

已完成：
- ✅ 聽牌符計算測試（單騎、邊張、嵌張、兩面聽、空組合）
- ✅ 支付方式測試（自摸、榮和、莊家自摸）
- ✅ 槓子符測試（明槓、暗槓）
- ✅ 雀頭符測試（三元牌、場風）

仍需要添加的測試：
1. **聽牌符計算測試**
   - 測試雙碰聽（+0符）- 需要更複雜的手牌結構

### 優先級 3：提高 rules.py 覆蓋率（目標：> 70%）

已完成：
- ✅ KAN/ANKAN 動作測試
- ✅ 三家和了檢查測試
- ✅ 嶺上開花檢查測試
- ✅ 流局處理測試
- ✅ 結束一局測試

仍需要添加的測試：
1. **實際場景測試**
   - 完整的搶槓和牌場景
   - 完整的嶺上開花和牌場景
   - 完整的流局處理場景（各種流局類型）

## 覆蓋率提升計劃

### ✅ 階段 1：關鍵功能測試（目標：70%）- **已完成**
- [x] 添加 KAN/ANKAN 動作測試
- [x] 添加聽牌符計算測試
- [x] 添加支付方式測試
- [x] 添加 game_state 測試

### ✅ 階段 2：邊界情況測試（目標：75%）- **已完成**
- [x] 添加三家和了測試
- [x] 添加流局處理測試
- [x] 添加狀態轉換測試

### 🟡 階段 3：完整覆蓋（目標：80%）- **進行中**
- [ ] 添加更多 rules.py 邊界情況測試
- [ ] 添加更多 scoring.py 邊界情況測試
- [ ] 添加錯誤處理測試
- [ ] 優化現有測試用例

## 如何查看詳細覆蓋率報告

1. **HTML 報告**：
   ```bash
   python -m pytest tests/ --cov=pyriichi --cov-report=html
   # 然後打開 htmlcov/index.html
   ```

2. **終端報告**：
   ```bash
   python -m pytest tests/ --cov=pyriichi --cov-report=term-missing
   ```

3. **簡潔報告**：
   ```bash
   python -m pytest tests/ --cov=pyriichi --cov-report=term
   ```

## 持續改進

- 每次添加新功能時，同時添加對應的測試用例
- 定期運行覆蓋率檢查，確保覆蓋率不下降
- 優先測試核心功能和邊界情況
- 使用覆蓋率報告識別未測試的代碼路徑
