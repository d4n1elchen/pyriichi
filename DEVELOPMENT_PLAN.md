# PyRiichi 開發計劃

## 開發時間表

### 階段 1：專案基礎架構（✅ 已完成）

#### 1.1 專案初始化
- [x] 建立專案目錄結構
- [x] 建立 requirements.txt
- [x] 建立 setup.py
- [x] 配置開發環境
- [x] 初始化 Git 倉庫

#### 1.2 基礎模組 - 牌組系統
- [x] 實現牌型枚舉（Tile）
  - [x] 萬子、筒子、條子、字牌
  - [x] 牌的表示和比較
  - [x] 牌的序列化
  - [x] 紅寶牌支持（is_red 標記）
  - [x] 標準字串格式（r5m 格式，符合日本麻將社區標準）
- [x] 實現牌組類（TileSet）
  - [x] 洗牌算法
  - [x] 發牌邏輯
  - [x] 摸牌邏輯
  - [x] 牌山管理
  - [x] 寶牌指示牌系統

**交付物**：
- [x] `tiles.py` - 完整的牌組系統
- [x] 單元測試（整合在相關測試中）

---

### 階段 2：手牌管理系統（✅ 已完成）

#### 2.1 手牌表示
- [x] 實現手牌類（Hand）
  - [x] 手牌存儲（13/14 張）
  - [x] 副露管理（明刻、明順，通過 Meld 類）
  - [x] 暗刻、暗槓管理（在手牌中）
- [x] 手牌操作
  - [x] 打牌（discard）
  - [x] 吃（chi）
  - [x] 碰（pon）
  - [x] 槓（kan，基本實現）
  - [x] 自摸（add_tile）

#### 2.2 手牌分析
- [x] 手牌排序（通過 Tile 的比較）
- [x] 手牌統計（_get_tile_counts 方法）
- [x] 聽牌判定（is_tenpai, get_waiting_tiles）
- [x] 和牌判定（is_winning_hand, get_winning_combinations）

**交付物**：
- [x] `hand.py` - 手牌管理系統
- [x] `test_hand.py` - 單元測試（9個測試用例）

---

### 階段 3：和牌判定系統（✅ 已完成）

#### 3.1 基本和牌判定
- [x] 標準和牌型判定
  - [x] 4 組面子 + 1 對子
  - [x] 遞迴算法實現（_find_melds 方法）
- [x] 特殊和牌型判定
  - [x] 七對子（_is_seven_pairs）
  - [x] 國士無雙（_is_kokushi_musou）
  - [ ] 十三不搭（流局判定，可選功能）

#### 3.2 聽牌判定
- [x] 聽牌檢測算法（is_tenpai）
- [x] 聽牌牌列表（get_waiting_tiles）
- [x] 和牌組合列表（get_winning_combinations）

#### 3.3 面子分解
- [x] 順子判定（_remove_sequence）
- [x] 刻子判定（_remove_triplet）
- [x] 對子判定（_remove_pair）
- [x] 槓子判定（整合在刻子判定中）

**交付物**：
- [x] 整合到 `hand.py` - 和牌判定系統
- [x] `test_hand.py` - 單元測試（包含和牌判定測試）

---

### 階段 4：役種（Yaku）判定系統（✅ 已完成，45+ 役種）

#### 4.1 基礎架構
- [x] 役種基類設計（YakuResult dataclass）
- [x] 役種判定接口（YakuChecker.check_all）
- [x] 多語言支持（日文、英文、中文）

#### 4.2 基本役實現（1 翻）
- [x] 立直（リーチ）
- [x] 一發（一発）
- [x] 門清自摸（門前清自摸和）
- [x] 斷么九（斷么九）
- [x] 平和（平和）- 已完善（檢查雀頭是否為役牌）
- [x] 一盃口（一盃口）
- [x] 役牌（場風、自風、三元牌）- 已完成（包含自風判定）

#### 4.3 特殊役實現（2-3 翻）
- [x] 三色同順（三色同順）
- [x] 三色同刻（三色同刻）
- [x] 一氣通貫（一気通貫）
- [x] 對對和（対々和）
- [x] 三暗刻（三暗刻）
- [x] 三槓子（三槓子）
- [x] 小三元（小三元）
- [x] 混老頭（混老頭）
- [x] 七對子（七対子）

#### 4.4 高級役實現（滿貫以上）
- [x] 清一色（清一色）- 6翻
- [x] 混一色（混一色）- 3翻
- [x] 純全帶么九（純全帯么九）- 3翻
- [x] 混全帶么九（混全帯么九）- 2翻
- [x] 二盃口（二盃口）- 3翻

#### 4.5 役滿實現
- [x] 天和、地和、人和 - 已完成（基於遊戲狀態追蹤）
- [x] 大三元、小四喜、大四喜
- [x] 四暗刻、四暗刻單騎 - 四暗刻已實現
- [x] 四槓子
- [x] 九蓮寶燈、純正九蓮寶燈
- [x] 國士無雙、國士無雙十三面 - 已完成（包含十三面判定）
- [x] 綠一色、清老頭、字一色
- [x] 四歸一 - 已實現

#### 4.6 複合役處理
- [x] 多役疊加邏輯（check_all 方法）
- [x] 翻數計算（han 字段累加）
- [x] 役種衝突檢測 - 完整實現（包含所有衝突規則）

**當前實現的衝突處理**：
- ✅ 七對子：不能與其他役種複合（除了立直）
- ✅ 國士無雙：不能與其他役種複合（除了立直）
- ✅ 役滿：不與非役滿役種複合（除了立直）
- ✅ 平和與役牌：衝突檢測已實現
- ✅ 斷么九與包含幺九的役種：衝突檢測已實現
- ✅ 對對和與需要順子的役種：衝突檢測已實現
- ✅ 一盃口與二盃口：互斥檢測已實現
- ✅ 清一色與混一色：互斥檢測已實現
- ✅ 純全帶与混全帶：互斥檢測已實現
- ✅ 平和與對對和：衝突檢測已實現
- ✅ 平和與一盃口、二盃口：衝突檢測已實現

**實現的衝突檢測**：
- [x] 平和與役牌衝突檢測
- [x] 斷么九與包含幺九役種衝突檢測
- [x] 對對和與順子役種衝突檢測
- [x] 一盃口與二盃口互斥檢測
- [x] 清一色與混一色互斥檢測
- [x] 純全帶与混全帶互斥檢測

**交付物**：
- [x] `yaku.py` - 役種判定系統
- [x] `test_yaku.py` - 單元測試（29個測試用例，涵蓋45+個役種和衝突檢測）

**已完成役種列表（45+個）**：
- 基本役（6個）：立直、斷么九、平和、一盃口、一發、門清自摸
- 特殊役（9個）：對對和、三色同順、三色同刻、一氣通貫、三暗刻、三槓子、小三元、混老頭、七對子
- 高級役（5個）：清一色（6翻）、混一色（3翻）、純全帶么九（3翻）、混全帶么九（2翻）、二盃口（3翻）
- 役牌（11個）：白、發、中、場風東、場風南、場風西、場風北、自風東、自風南、自風西、自風北
- 役滿（13+個）：大三元、四暗刻、國士無雙、國士無雙十三面、小四喜、大四喜、清老頭、字一色、四槓子、綠一色、九蓮寶燈、四歸一、天和、地和、人和
- 特殊和牌役（3個）：海底撈月、河底撈魚、嶺上開花

---

### 階段 5：得分計算系統（✅ 已完成）

#### 5.1 符數計算
- [x] 基本符計算（20符）
- [x] 副底符計算（門清榮和+10、門清自摸+2、非門清自摸+2）
- [x] 面子符計算（刻子符、槓子符）
- [x] 雀頭符計算（役牌對子+2）
- [ ] 聽牌符計算 - 框架已實現，需完善聽牌類型判定
- [x] 符數進位邏輯（進位到10）
- [x] 平和特殊處理（固定20/22符）

#### 5.2 翻數計算
- [x] 基本翻數（從役種系統）
- [x] 寶牌計算（整合在規則引擎中）
  - [x] 表寶牌
  - [x] 裡寶牌（立直時）
  - [x] 紅寶牌
- [x] 翻數疊加

#### 5.3 點數計算
- [x] 基本點計算（符數 × 2^(翻數+2)）
- [x] 滿貫以上處理（滿貫、跳滿、倍滿、三倍滿、役滿）
- [x] 支付方式計算 - 已完成
  - [x] 自摸支付（莊家2倍、閒家1倍）
  - [x] 榮和支付（放銃者支付全部）
- [x] 本場和供託處理 - 已完成（本場+300點，供託分配）

#### 5.4 特殊得分
- [x] 流局滿貫判定（在規則引擎中）
- [x] 役滿得分計算
- [x] 倍役滿、三倍役滿計算

**交付物**：
- [x] `scoring.py` - 得分計算系統
- [x] `test_scoring.py` - 單元測試（6個測試用例）

---

### 階段 6：遊戲規則引擎（✅ 基本完成，核心功能已實現）

#### 6.1 基本遊戲流程
- [x] 遊戲初始化（start_game）
- [x] 配牌流程（deal）
- [x] 回合管理（摸牌、打牌）
- [x] 鳴牌處理框架（吃、碰、槓）- 手牌層已實現，規則引擎層需完善
- [x] 和牌流程（check_win）
- [x] 流局流程（check_draw, handle_draw）

#### 6.2 遊戲狀態管理
- [x] 局數管理（東、南、西、北）- GameState 已實現
- [x] 場風、自風管理 - GameState 已實現
- [x] 本場數管理 - GameState 已實現
- [x] 供託棒管理 - GameState 已實現
- [x] 玩家點數管理 - GameState 已實現
- [x] 局數轉換和結束處理（end_round）

#### 6.3 流局處理
- [x] 四風連打 - 已完成（基於捨牌歷史追蹤）
- [x] 九種九牌判定（check_kyuushu_kyuuhai）- 已完成（包含第一巡判定）
- [x] 四家立直（全員聽牌流局，suucha_riichi）
- [x] 四槓散了 - 已完成（基於槓次數追蹤）
- [x] 三家和了 - 已完成
- [x] 流局滿貫判定（check_flow_mangan）

#### 6.4 特殊規則
- [x] 立直規則（can_act, execute_action）
- [x] 一發規則 - 已完成（基於立直後回合數追蹤）
- [x] 搶槓規則 - 已完成（明槓時檢查其他玩家是否可以和牌）
- [x] 嶺上開花 - 已完成（槓後摸牌和牌判定）
- [x] 海底撈月 - 已完成（自摸最後一張牌）
- [x] 河底撈魚 - 已完成（榮和最後一張牌）

#### 6.5 寶牌系統
- [x] 表寶牌計算和顯示
- [x] 裡寶牌計算（立直時）
- [x] 紅寶牌識別
- [x] 寶牌翻數統計（_count_dora）

**交付物**：
- [x] `rules.py` - 規則引擎（覆蓋率84%）
- [x] `game_state.py` - 遊戲狀態管理（覆蓋率100%）
- [x] `test_rules.py` - 單元測試（65個測試用例）

---

### 階段 7：測試和優化（✅ 基本完成）

#### 7.1 測試完善
- [x] 單元測試基礎框架（215個測試用例全部通過）
  - [x] test_hand.py（多個測試）
  - [x] test_yaku.py（多個測試）
  - [x] test_scoring.py（多個測試）
  - [x] test_rules.py（多個測試）
  - [x] test_game_state.py（多個測試）
  - [x] test_tiles.py（多個測試）
  - [x] test_utils.py（多個測試）
  - [x] test_integration.py（整合測試）
- [x] 單元測試覆蓋率檢查 - 已完成（當前覆蓋率：86%，詳見 COVERAGE_REPORT.md）
- [x] rules.py 覆蓋率提升 - 已完成（從68%提升到84%，超過80%目標）
- [x] 整合測試 - 已完成（test_integration.py 包含完整遊戲流程、特殊規則、流局場景等測試）
- [x] 邊界情況測試 - 已完成（和牌、聽牌、流局、特殊規則等）
- [x] 性能測試 - 已完成（創建 benchmark_performance.py 性能基準測試）

#### 7.2 代碼優化
- [x] 代碼結構優化（模組化設計）
- [x] 類型警告修正（修正所有 winning_combination 類型不匹配問題）
- [x] 字串格式標準化（紅寶牌採用標準格式 r5m，符合日本麻將社區慣例）
- [x] 性能優化 - 已完成
  - [x] 和牌判定算法優化（使用回溯減少字典複製，減少對象分配）
  - [x] 牌計數緩存（減少重複計算，提升約 10% 性能）
  - [x] 聽牌判定優化（只檢查相關牌，減少不必要的嘗試）
  - [x] 聽牌列表獲取優化（智能候選選擇）
- [x] 代碼風格檢查（通過 linter）

#### 7.3 文檔完善
- [x] API 文檔（API_DESIGN.md, API_SUMMARY.md）
- [x] 使用示例（examples/basic_usage.py, README.md）
- [x] 開發文檔（DEVELOPMENT_PLAN.md, REQUIREMENTS.md）
- [x] 字串表示法說明（README.md 中詳細說明牌的字符串格式）
- [x] 紅寶牌格式標準化（採用日本麻將社區標準格式 r5m）
- [ ] 詳細的 API 參考文檔 - 待完成（可選）

**交付物**：
- [x] 完整的測試套件（215個測試用例，包含單元測試和整合測試）
- [x] 清晰的代碼結構
- [x] 完整的文檔（README, API設計, 開發計劃等）
- [x] 測試覆蓋率報告（COVERAGE_REPORT.md）

---

## 開發優先級

### 高優先級（核心功能）
1. 牌組系統
2. 手牌管理
3. 和牌判定
4. 基本役種（至少 10 個）
5. 得分計算
6. 基本遊戲流程

### 中優先級（重要功能）
1. 完整役種系統
2. 流局處理
3. 遊戲狀態管理
4. 特殊規則

### 低優先級（增強功能）
1. 性能優化
2. 額外的便利功能
3. 統計和分析功能

---

## 開發方法論

### 測試驅動開發（TDD）
- 先寫測試用例
- 再實現功能
- 確保測試通過

### 迭代開發
- 每個階段完成後進行測試
- 及時發現和修復問題
- 保持代碼可運行狀態

### 代碼審查
- 每個模組完成後進行代碼審查
- 確保代碼質量和一致性

---

## 風險管理

### 技術風險
- **和牌判定算法複雜度高**
  - 緩解：參考現有實現，使用遞迴算法
- **役種判定可能遺漏邊界情況**
  - 緩解：建立完整的測試用例庫
- **得分計算規則複雜**
  - 緩解：分階段實現，逐步驗證

### 時間風險
- **開發時間可能超出預期**
  - 緩解：優先實現核心功能，非核心功能可後續補充

---

## 成功標準

1. ✅ 能夠正確判定所有標準和牌型（標準型、七對子、國士無雙）
2. ✅ 能夠正確判定至少 20 個役種（當前：45+個，已大幅超越目標）
3. ✅ 能夠正確計算得分（符數、翻數、點數）
4. ✅ 能夠完成一局完整的遊戲流程（基本流程已實現，包含特殊規則）
5. ✅ 單元測試覆蓋率 > 80%（215個測試用例，覆蓋率86%，已超過目標）
6. ✅ 代碼符合 PEP 8 規範（通過 linter 檢查）
7. ✅ 有完整的使用文檔（README, API設計, 開發計劃等）

## 最近更新（2025-01-XX）

### 性能優化
- ✅ **和牌判定算法優化**：
  - 使用回溯算法減少字典複製，避免每次遞迴都創建新對象
  - 原地修改計數字典並在回溯時恢復，大幅減少內存分配
  - 標準和牌型判定平均時間 < 0.06ms
- ✅ **牌計數緩存**：
  - 在手牌類中添加 `_tile_counts_cache` 緩存機制
  - 在手牌修改時自動清除緩存
  - 緩存命中時性能提升約 10%
- ✅ **聽牌判定優化**：
  - 智能候選選擇：只檢查與手牌相關的牌（相同、相鄰、順子相關）
  - 減少從 34 種牌到平均 10-20 種候選牌
  - 標準聽牌判定平均時間約 1.3ms
- ✅ **性能測試工具**：
  - 創建 `benchmark_performance.py` 性能基準測試腳本
  - 包含和牌判定、聽牌判定、聽牌列表獲取等測試
  - 可用於持續監控性能變化

### 測試完善
- ✅ **整合測試完成**：新增 test_integration.py，包含完整遊戲流程、特殊規則、流局場景等測試
  - 完整和牌流程測試（自摸、榮和）
  - 完整遊戲流程測試（包含鳴牌）
  - 特殊規則流程測試（立直、槓）
  - 流局場景測試（九種九牌）
  - 多模組整合測試（手牌-役種-得分計算）
  - 真實場景測試（多局遊戲流程）
  - 錯誤處理測試
- ✅ **測試數量提升**：從 199 個測試用例增加到 215 個測試用例
- ✅ **測試覆蓋率維持**：總體覆蓋率 86%，所有核心模組覆蓋率均超過 75%

### 代碼質量改進
- ✅ **類型警告修正**：修正所有 `winning_combination` 類型不匹配問題
  - 將 `get_winning_combinations()` 返回的 `Tuple` 轉換為 `List`
  - 更新所有測試文件（test_integration.py, test_yaku.py, test_scoring.py）
  - 共修正 72 處類型警告

### 格式標準化
- ✅ **紅寶牌格式標準化**：採用日本麻將社區標準格式
  - 從 `[5p]` 格式改為標準 `r5p` 格式（r 前綴）
  - 符合日本麻將社區廣泛使用的標準
  - 輸入和輸出格式統一，支持往返轉換
  - 更新所有相關代碼和測試

### 文檔完善
- ✅ **README 更新**：
  - 新增詳細的字串表示法說明章節
  - 更新所有示例代碼使用標準格式
  - 添加類型轉換說明和注意事項
  - 更新功能列表，標記所有功能為已實現
- ✅ **示例代碼更新**：
  - 添加完整的和牌判定、役種檢查、得分計算示例
  - 展示正確的類型轉換使用方法

## 當前進度總結

### ✅ 已完成的核心功能
- 牌組系統（Tile, TileSet）- 完整實現
- 手牌管理（Hand）- 完整實現，包含和牌判定、聽牌判定
- 鳴牌操作（吃、碰、槓）- 完整實現
- 役種判定系統（45+個役種）- 基本役種、高級役種和役滿已實現（包含天和、地和、人和等特殊役滿）
- 得分計算系統（符數、翻數、點數）- 完整實現
- 規則引擎（遊戲流程、流局、寶牌、特殊規則）- 核心功能已實現（包含一発、海底撈月、河底撈魚、四風連打、四槓散了等）
- 遊戲狀態管理（局數、風、點數）- 完整實現
- 專案初始化（setup.py, Git 倉庫）- 完整實現

### 🟡 待完善的功能

#### 役種系統（優先級：中）
- [x] 三色同刻（2翻）- 已完成
- [x] 小三元（2翻）- 已完成
- [x] 混老頭（2翻）- 已完成
- [x] 純全帶么九（3翻）- 已完成
- [x] 混全帶么九（2翻）- 已完成
- [x] 二盃口（3翻）- 已完成
- [x] 三槓子（2翻）- 已完成
- [x] 一發（1翻）- 已完成（基於立直後回合數追蹤）
- [x] 門清自摸（1翻）- 已完成
- [x] 大部分役滿（14個役滿）- 已完成（包含天和、地和、人和）
- [x] 天和、地和、人和（需要遊戲狀態追蹤）- 已完成
- [x] 國士無雙十三面（需要更精確的判定）- 已完成
- [x] 自風判定（需完善玩家位置邏輯）- 已完成
- [x] 海底撈月、河底撈魚 - 已完成

#### 役種複合規則（優先級：中）
- [x] 基本衝突檢測（七對子、國士無雙、役滿）- 已完成
- [x] 平和與役牌衝突檢測 - 已完成
- [x] 斷么九與包含幺九役種衝突檢測 - 已完成
- [x] 對對和與順子役種衝突檢測 - 已完成
- [x] 一盃口與二盃口互斥檢測 - 已完成
- [x] 清一色與混一色互斥檢測 - 已完成
- [x] 純全帶与混全帶互斥檢測 - 已完成
- [x] 完整的役種複合規則測試 - 已完成

#### 特殊規則（優先級：中）
- [x] 一發規則（需記錄立直後回合數）- 已完成
- [x] 搶槓規則（需處理明槓時的和牌判定）- 已完成
- [x] 嶺上開花（需處理槓後摸牌）- 已完成（包含役種判定）
- [x] 海底撈月（需判斷是否為最後一張牌）- 已完成
- [x] 河底撈魚（需判斷是否為最後一張牌）- 已完成

#### 流局處理（優先級：中）
- [x] 四風連打（需記錄前四張捨牌）- 已完成
- [x] 四槓散了（需記錄槓的次數）- 已完成
- [x] 三家和了（需處理多人和牌情況）- 已完成
- [x] 九種九牌第一巡判定（需記錄是否為第一巡）- 已完成
- [x] 流局滿貫判定（需檢查聽牌且聽牌牌都是幺九牌）- 已完成

#### 得分計算完善（優先級：低）
- [x] 聽牌符詳細計算（需判斷聽牌類型：兩面、邊張、嵌張、單騎、雙碰）- 已完成
- [x] 支付方式詳細計算（自摸：莊家2倍、閒家1倍；榮和：放銃者支付全部）- 已完成
- [x] 本場和供託處理（本場+300點，供託分配）- 已完成

#### 項目配置（優先級：低）
- [x] setup.py（用於打包發布）- 已完成
- [x] Git 倉庫初始化 - 已完成
- [ ] CI/CD 配置（可選）- 待完成

### 📊 測試統計
- 總測試用例：215個（全部通過）
- 測試通過率：100%
- 測試文件：8個（test_hand, test_yaku, test_scoring, test_rules, test_game_state, test_tiles, test_utils, test_integration）
- 核心模組：8個（tiles, hand, game_state, yaku, scoring, rules, utils, __init__）
- **測試覆蓋率：86%**（已超過 80% 目標！🎉）
- **rules.py 覆蓋率：84%**（已超過 80% 目標！🎉）
- **完美覆蓋模組（100%）**：game_state.py, tiles.py, utils.py, __init__.py
- **優秀覆蓋模組（≥95%）**：scoring.py (98%), tiles.py (100%)
- **良好覆蓋模組（≥75%）**：hand.py (87%), rules.py (84%), yaku.py (79%)

### 🔍 檢查項目（無遺漏）
- ✅ 牌組系統：完整實現，包含寶牌系統
- ✅ 手牌管理：完整實現，包含和牌判定、聽牌判定、鳴牌操作（吃、碰、槓、暗槓）
- ✅ 和牌判定：完整實現（標準型、七對子、國士無雙）
- ✅ 役種判定：45+個役種已實現，涵蓋基本役、特殊役、高級役、役滿（包含天和、地和、人和、國士無雙十三面等）
- ✅ 得分計算：符數、翻數、點數計算完整實現
- ✅ 規則引擎：基本遊戲流程、流局、寶牌系統、特殊規則已實現（一発、海底撈月、河底撈魚、四風連打、四槓散了、搶槓、嶺上開花、三家和了等）
- ✅ 遊戲狀態：局數、風、點數管理完整實現
- ✅ 工具函數：parse_tiles, format_tiles, is_winning_hand 已實現
  - ✅ 支持標準字串格式（1m, 2p, 3s, 1z 等）
  - ✅ 支持紅寶牌標準格式（r5m, r5p, r5s）
  - ✅ 輸入輸出格式統一，支持往返轉換
- ✅ 測試覆蓋：215個測試用例（包含單元測試和整合測試），涵蓋所有核心功能、特殊規則和衝突檢測，覆蓋率86%
- ✅ 文檔：README, API設計, 開發計劃, 使用示例完整
  - ✅ README 包含完整的字串表示法說明
  - ✅ 示例代碼展示和牌判定、役種檢查、得分計算完整流程
  - ✅ 所有示例使用正確的類型轉換（list(combinations[0])）

---

## 後續擴展（未來版本）

1. 網路對戰功能
2. 圖形界面
3. 更強的 AI
4. 統計和分析功能
5. 自定義規則支持
6. 多語言支持
